<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hop Wallet Test DApp</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-item.connected {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
        }

        .status-item.disconnected {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 1.2rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(180deg, #00d4ff, #7b2cbf);
            border-radius: 2px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        button {
            background: linear-gradient(135deg, #00d4ff 0%, #7b2cbf 100%);
            border: none;
            color: #fff;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: none;
        }

        button.danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }

        input, textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 16px;
            color: #fff;
            font-size: 0.95rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #00d4ff;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .result-box {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 300px;
            overflow-y: auto;
        }

        .result-box.success {
            border-color: #00d4ff;
            background: rgba(0, 212, 255, 0.1);
        }

        .result-box.error {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
        }

        .event-log {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 16px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
        }

        .event-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            gap: 10px;
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-time {
            color: rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .event-name {
            color: #00d4ff;
            flex-shrink: 0;
        }

        .event-data {
            color: rgba(255, 255, 255, 0.8);
            word-break: break-all;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .wallet-not-found {
            text-align: center;
            padding: 60px 20px;
        }

        .wallet-not-found h2 {
            justify-content: center;
            margin-bottom: 20px;
        }

        .wallet-not-found p {
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 20px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s infinite;
        }

        .copy-btn {
            padding: 6px 12px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .inline-flex {
            display: flex;
            align-items: center;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Endless Wallet Test DApp</h1>
            <p style="color: rgba(255,255,255,0.6);">Test all wallet extension features</p>
        </header>

        <div id="wallet-not-found" class="card wallet-not-found" style="display: none;">
            <h2>Wallet Not Detected</h2>
            <p>Please install the Endless Wallet extension and refresh this page.</p>
            <button onclick="location.reload()">Refresh Page</button>
        </div>

        <div id="main-content" style="display: none;">
            <!-- Status Bar -->
            <div class="status-bar">
                <div id="connection-status" class="status-item disconnected">
                    Status: Disconnected
                </div>
                <div id="network-status" class="status-item">
                    Network: --
                </div>
                <div id="address-status" class="status-item">
                    Address: --
                </div>
            </div>

            <div class="grid-2">
                <!-- Connection -->
                <div class="card">
                    <h2>Connection</h2>
                    <div class="btn-group">
                        <button id="btn-connect" onclick="connectWallet()">Connect</button>
                        <button id="btn-disconnect" onclick="disconnectWallet()" class="danger" disabled>Disconnect</button>
                    </div>
                    <div class="btn-group">
                        <button onclick="checkConnection()" class="secondary">Check isConnected</button>
                    </div>
                    <div id="connection-result" class="result-box" style="display: none;"></div>
                </div>

                <!-- Account Info -->
                <div class="card">
                    <h2>Account Info</h2>
                    <div class="btn-group">
                        <button onclick="getAccount()">Get Account</button>
                        <button onclick="getNetwork()" class="secondary">Get Network</button>
                    </div>
                    <div id="account-result" class="result-box" style="display: none;"></div>
                </div>
            </div>

            <!-- Sign Message -->
            <div class="card">
                <h2>Sign Message</h2>
                <div class="input-group">
                    <label>Message to Sign</label>
                    <input type="text" id="sign-message-input" value="Hello, Endless Wallet!" placeholder="Enter message to sign">
                </div>
                <div class="input-group">
                    <label>Nonce (optional)</label>
                    <input type="text" id="sign-nonce-input" placeholder="Enter nonce (optional)">
                </div>
                <div class="btn-group">
                    <button onclick="signMessage()">Sign Message</button>
                </div>
                <div id="sign-result" class="result-box" style="display: none;"></div>
            </div>

            <!-- Sign and Submit Transaction -->
            <div class="card">
                <h2>Sign & Submit Transaction</h2>
                <div class="input-group">
                    <label>Recipient Address</label>
                    <input type="text" id="tx-recipient" placeholder="Enter recipient address (Bs58)">
                </div>
                <div class="input-group">
                    <label>Amount (in smallest unit)</label>
                    <input type="number" id="tx-amount" value="100000000" placeholder="Amount">
                </div>
                <div class="input-group">
                    <label>Custom Payload (JSON, optional - leave empty for EDS transfer)</label>
                    <textarea id="tx-payload" placeholder='{"function": "0x1::endless_coin::transfer", "typeArguments": [], "functionArguments": ["recipient", amount]}'></textarea>
                </div>
                <div class="btn-group">
                    <button onclick="signAndSubmitTransaction()">Sign & Submit</button>
                    <button onclick="fillSamplePayload()" class="secondary">Fill Sample Payload</button>
                </div>
                <div id="tx-result" class="result-box" style="display: none;"></div>
            </div>

            <!-- Event Listeners -->
            <div class="card">
                <h2>Event Listeners</h2>
                <div class="btn-group">
                    <button id="btn-subscribe" onclick="subscribeEvents()">Subscribe All Events</button>
                    <button id="btn-unsubscribe" onclick="unsubscribeEvents()" class="secondary" disabled>Unsubscribe All</button>
                    <button onclick="clearEventLog()" class="secondary">Clear Log</button>
                </div>
                <div class="event-log" id="event-log">
                    <div style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                        No events yet. Subscribe to start listening.
                    </div>
                </div>
            </div>

            <!-- Debug Console -->
            <div class="card">
                <h2>Debug Console</h2>
                <div class="input-group">
                    <label>Custom Method Call</label>
                    <input type="text" id="debug-method" placeholder="Method name (e.g., getAccount)">
                </div>
                <div class="input-group">
                    <label>Parameters (JSON)</label>
                    <textarea id="debug-params" placeholder="null or JSON parameters"></textarea>
                </div>
                <div class="btn-group">
                    <button onclick="debugCall()">Execute</button>
                </div>
                <div id="debug-result" class="result-box" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        // State
        let isConnected = false;
        let currentAccount = null;
        let eventSubscribed = false;
        const eventCallbacks = {};

        // Event types
        const EVENTS = [
            'connect',
            'disconnect',
            'accountChange',
            'networkChange',
            'colorModeChange'
        ];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkWalletExists();
        });

        // Also listen for wallet injection
        window.addEventListener('endless#initialized', () => {
            checkWalletExists();
        });

        function checkWalletExists() {
            if (typeof window.endless !== 'undefined' && window.endless.isEndless) {
                document.getElementById('wallet-not-found').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
                logEvent('system', 'Wallet detected');
            } else {
                document.getElementById('wallet-not-found').style.display = 'block';
                document.getElementById('main-content').style.display = 'none';
            }
        }

        // Connection functions
        async function connectWallet() {
            showResult('connection-result', 'Connecting...', 'loading');
            try {
                const result = await window.endless.connect();
                console.log('Connect result:', result);

                if (result.status === 'Approved') {
                    isConnected = true;
                    currentAccount = result.args;
                    updateConnectionUI(true, result.args);
                    showResult('connection-result', JSON.stringify(result, null, 2), 'success');
                } else {
                    showResult('connection-result', 'Connection rejected: ' + (result.message || 'User rejected'), 'error');
                }
            } catch (error) {
                showResult('connection-result', 'Error: ' + error.message, 'error');
            }
        }

        async function disconnectWallet() {
            showResult('connection-result', 'Disconnecting...', 'loading');
            try {
                await window.endless.disconnect();
                isConnected = false;
                currentAccount = null;
                updateConnectionUI(false);
                showResult('connection-result', 'Disconnected successfully', 'success');
            } catch (error) {
                showResult('connection-result', 'Error: ' + error.message, 'error');
            }
        }

        async function checkConnection() {
            showResult('connection-result', 'Checking connection...', 'loading');
            try {
                const address = currentAccount?.address || '';
                const result = await window.endless.isConnected(address);
                showResult('connection-result', 'isConnected: ' + JSON.stringify(result), result ? 'success' : 'error');
            } catch (error) {
                showResult('connection-result', 'Error: ' + error.message, 'error');
            }
        }

        function updateConnectionUI(connected, account = null) {
            const statusEl = document.getElementById('connection-status');
            const addressEl = document.getElementById('address-status');
            const connectBtn = document.getElementById('btn-connect');
            const disconnectBtn = document.getElementById('btn-disconnect');

            if (connected && account) {
                statusEl.textContent = 'Status: Connected';
                statusEl.className = 'status-item connected';
                addressEl.textContent = 'Address: ' + truncateAddress(account.address);
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                statusEl.textContent = 'Status: Disconnected';
                statusEl.className = 'status-item disconnected';
                addressEl.textContent = 'Address: --';
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }

        // Account functions
        async function getAccount() {
            showResult('account-result', 'Fetching account...', 'loading');
            try {
                const result = await window.endless.getAccount();
                console.log('getAccount result:', result);

                if (result.status === 'Approved') {
                    currentAccount = result.args;
                    showResult('account-result', JSON.stringify(result, null, 2), 'success');
                } else {
                    showResult('account-result', 'Rejected: ' + (result.message || 'User rejected'), 'error');
                }
            } catch (error) {
                showResult('account-result', 'Error: ' + error.message, 'error');
            }
        }

        async function getNetwork() {
            showResult('account-result', 'Fetching network...', 'loading');
            try {
                const result = await window.endless.getNetwork();
                console.log('getNetwork result:', result);

                if (result.status === 'Approved') {
                    document.getElementById('network-status').textContent = 'Network: ' + result.args.name;
                    showResult('account-result', JSON.stringify(result, null, 2), 'success');
                } else {
                    showResult('account-result', 'Rejected: ' + (result.message || 'User rejected'), 'error');
                }
            } catch (error) {
                showResult('account-result', 'Error: ' + error.message, 'error');
            }
        }

        // Sign Message
        async function signMessage() {
            const message = document.getElementById('sign-message-input').value;
            const nonce = document.getElementById('sign-nonce-input').value;

            if (!message) {
                showResult('sign-result', 'Please enter a message to sign', 'error');
                return;
            }

            showResult('sign-result', 'Signing message...', 'loading');
            try {
                const params = {
                    message: message,
                    nonce: nonce || undefined
                };
                const result = await window.endless.signMessage(params);
                console.log('signMessage result:', result);
                showResult('sign-result', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                showResult('sign-result', 'Error: ' + error.message, 'error');
            }
        }

        // Sign and Submit Transaction
        async function signAndSubmitTransaction() {
            const recipient = document.getElementById('tx-recipient').value;
            const amount = document.getElementById('tx-amount').value;
            const customPayload = document.getElementById('tx-payload').value.trim();

            let payload;

            if (customPayload) {
                try {
                    payload = JSON.parse(customPayload);
                } catch (e) {
                    showResult('tx-result', 'Invalid JSON payload: ' + e.message, 'error');
                    return;
                }
            } else {
                if (!recipient) {
                    showResult('tx-result', 'Please enter a recipient address', 'error');
                    return;
                }
                if (!amount) {
                    showResult('tx-result', 'Please enter an amount', 'error');
                    return;
                }

                payload = {
                    function: "0x1::endless_coin::transfer",
                    typeArguments: [],
                    functionArguments: [recipient, parseInt(amount)]
                };
            }

            showResult('tx-result', 'Submitting transaction...', 'loading');
            try {
                const result = await window.endless.signAndSubmitTransaction({
                    payload: payload
                });
                console.log('signAndSubmitTransaction result:', result);

                if (result.status === 'Approved') {
                    showResult('tx-result', 'Transaction submitted!\nHash: ' + result.args.hash + '\n\nFull result:\n' + JSON.stringify(result, null, 2), 'success');
                } else {
                    showResult('tx-result', 'Rejected: ' + (result.message || 'User rejected'), 'error');
                }
            } catch (error) {
                showResult('tx-result', 'Error: ' + error.message, 'error');
            }
        }

        function fillSamplePayload() {
            const samplePayload = {
                function: "0x1::endless_coin::transfer",
                typeArguments: [],
                functionArguments: ["RECIPIENT_ADDRESS_HERE", 100000000]
            };
            document.getElementById('tx-payload').value = JSON.stringify(samplePayload, null, 2);
        }

        // Event Listeners
        function subscribeEvents() {
            if (eventSubscribed) return;

            EVENTS.forEach(event => {
                const callback = (data) => {
                    logEvent(event, data);
                };
                eventCallbacks[event] = callback;
                window.endless.on(event, callback);
            });

            eventSubscribed = true;
            document.getElementById('btn-subscribe').disabled = true;
            document.getElementById('btn-unsubscribe').disabled = false;
            logEvent('system', 'Subscribed to all events');
        }

        function unsubscribeEvents() {
            if (!eventSubscribed) return;

            EVENTS.forEach(event => {
                if (eventCallbacks[event]) {
                    window.endless.off(event, eventCallbacks[event]);
                    delete eventCallbacks[event];
                }
            });

            eventSubscribed = false;
            document.getElementById('btn-subscribe').disabled = false;
            document.getElementById('btn-unsubscribe').disabled = true;
            logEvent('system', 'Unsubscribed from all events');
        }

        function logEvent(eventName, data) {
            const logEl = document.getElementById('event-log');
            const time = new Date().toLocaleTimeString();

            // Clear placeholder if first event
            if (logEl.querySelector('div[style]')) {
                logEl.innerHTML = '';
            }

            const eventItem = document.createElement('div');
            eventItem.className = 'event-item';
            eventItem.innerHTML = `
                <span class="event-time">${time}</span>
                <span class="event-name">[${eventName}]</span>
                <span class="event-data">${typeof data === 'object' ? JSON.stringify(data) : data}</span>
            `;
            logEl.insertBefore(eventItem, logEl.firstChild);
        }

        function clearEventLog() {
            document.getElementById('event-log').innerHTML = `
                <div style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                    Log cleared. Events will appear here.
                </div>
            `;
        }

        // Debug Console
        async function debugCall() {
            const method = document.getElementById('debug-method').value.trim();
            const paramsStr = document.getElementById('debug-params').value.trim();

            if (!method) {
                showResult('debug-result', 'Please enter a method name', 'error');
                return;
            }

            let params = null;
            if (paramsStr && paramsStr !== 'null') {
                try {
                    params = JSON.parse(paramsStr);
                } catch (e) {
                    showResult('debug-result', 'Invalid JSON parameters: ' + e.message, 'error');
                    return;
                }
            }

            showResult('debug-result', `Calling ${method}...`, 'loading');
            try {
                if (typeof window.endless[method] !== 'function') {
                    showResult('debug-result', `Method "${method}" not found on wallet`, 'error');
                    return;
                }

                const result = await window.endless[method](params);
                console.log(`${method} result:`, result);
                showResult('debug-result', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                showResult('debug-result', 'Error: ' + error.message, 'error');
            }
        }

        // Utility functions
        function showResult(elementId, content, type) {
            const el = document.getElementById(elementId);
            el.style.display = 'block';
            el.textContent = content;
            el.className = 'result-box';
            if (type === 'success') el.classList.add('success');
            if (type === 'error') el.classList.add('error');
            if (type === 'loading') el.classList.add('loading');
        }

        function truncateAddress(address) {
            if (!address) return '--';
            return address.slice(0, 8) + '...' + address.slice(-6);
        }

        // Log initial state
        console.log('Endless Wallet Test DApp loaded');
        console.log('window.endless:', window.endless);
    </script>
</body>
</html>
